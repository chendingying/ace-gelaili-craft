<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ace.product.mapper.ProcessMapper">

    <!--  模糊查询工艺型号-->
    <select id="selectProcessU9Conding" resultType="java.util.HashMap">
        select pro.u9_coding as u9Coding,pro.product_model as productModel from product_process pro
        where version = (select max(version) from product_process where isnumeric(version)=1 and u9_coding = pro.u9_coding)
        and u9_coding like '%'+#{u9Coding, jdbcType=VARCHAR}+ '%'
    </select>

    <!-- 查询工艺信息 -->
    <select id="selectProcessForMaxVersion" resultType="java.util.HashMap">
        select pro.id,pro.u9_coding,pro.product_model,pro.customer,pro.version,pro.file_coding,pro.box_number,pro.case_number from product_process pro
        where pro.version = (select max(version) from product_process where isnumeric(version)=1 and u9_coding = pro.u9_coding)
        <if test="u9Coding != null">
            and pro.u9_coding = #{u9Coding, jdbcType=VARCHAR}
        </if>
        <if test="customer != null">
            and pro.customer = #{customer, jdbcType=VARCHAR}
        </if>
        <if test="status != null">
            and pro.status = #{status,jdbcType=INTEGER}
        </if>
    </select>

    <!-- u9Coding编码查询最新版本 -->
    <select id="selectMaxVersionForU9Coding" resultType="java.lang.String">
        select max(version) version from product_process where isnumeric(version)=1 and u9_coding = #{u9Coding, jdbcType=VARCHAR}
        <if test="id != null">
            and id != #{id,jdbcType=INTEGER}
        </if>
    </select>

    <!--批量作废 -->
    <update id="updateInvalid" parameterType="java.util.List">
        <if test="list !=null and list.size > 0">
        update product_process
        <trim prefix="set" suffixOverrides=",">
            <trim prefix="status =case" suffix="end,">
                <foreach collection="list" item="item" index="index">
                   when id=#{item.id} then #{item.status}
                </foreach>
            </trim>
        </trim>
        where id in
        <foreach collection="list" index="index" item="item" separator="," open="(" close=")">
            #{item.id,jdbcType=INTEGER}
        </foreach>
        </if>
    </update>


    <update id="updateRegainVersion">
        update product_process set status = 1
          where u9_coding = #{u9Coding, jdbcType=VARCHAR}  and  version = #{version, jdbcType=VARCHAR}
    </update>

    <update id="updateInvalidVersion">
      update product_process set status = 0 where id = #{id,jdbcType=INTEGER} and u9_coding = #{u9Coding, jdbcType=VARCHAR}
    </update>
</mapper>